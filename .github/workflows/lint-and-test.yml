name: Lint & Test (shellcheck, shfmt, bats)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  shellcheck:
    name: ShellCheck Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install ShellCheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Run ShellCheck on main scripts
        run: |
          shellcheck -x -S warning citadel.sh || true

      - name: Run ShellCheck on libraries
        run: |
          shellcheck -x -S warning lib/*.sh || true

      - name: Run ShellCheck on modules
        run: |
          shellcheck -x -S warning modules/*.sh || true

      - name: Run ShellCheck on legacy (optional)
        run: |
          shellcheck -S warning legacy/*.sh || true
        continue-on-error: true

  shfmt:
    name: Shell Format Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install shfmt
        run: |
          wget -qO /tmp/shfmt https://github.com/mvdan/sh/releases/download/v3.8.0/shfmt_v3.8.0_linux_amd64
          chmod +x /tmp/shfmt
          sudo mv /tmp/shfmt /usr/local/bin/shfmt

      - name: Check formatting (dry-run)
        run: |
          shfmt -d -i 4 -ci citadel.sh || true
          shfmt -d -i 4 -ci lib/*.sh || true
          shfmt -d -i 4 -ci modules/*.sh || true
        continue-on-error: true

  bats:
    name: BATS Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install BATS
        run: |
          sudo apt-get update
          sudo apt-get install -y bats

      - name: Run BATS tests
        run: |
          if [ -d "tests" ] && [ -n "$(find tests -name '*.bats' 2>/dev/null)" ]; then
            bats tests/*.bats
          else
            echo "No BATS tests found - skipping"
          fi
        continue-on-error: true

  security:
    name: Security Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for hardcoded secrets
        run: |
          echo "Checking for potential secrets..."
          ! grep -r -E '(password|secret|api_key|token).*=.*["\047][^"\047]{8,}' --include="*.sh" . || echo "Warning: potential secrets found"
        continue-on-error: true

      - name: Check for set -euo pipefail
        run: |
          echo "Checking for bash strict mode..."
          for file in citadel.sh lib/*.sh modules/*.sh; do
            if [ -f "$file" ]; then
              if ! grep -q "set -euo pipefail\|set -e.*-u.*-o pipefail" "$file"; then
                echo "Warning: $file missing 'set -euo pipefail'"
              fi
            fi
          done
        continue-on-error: true
