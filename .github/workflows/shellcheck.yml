name: ShellCheck

on:
  push:
  pull_request:

jobs:
  shellcheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install ShellCheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Run ShellCheck
        run: |
          # Check main script
          shellcheck -S warning -e SC2034 citadel.sh
          
          # Check core libraries
          shellcheck -S warning -e SC2034 lib/*.sh
          
          # Check modules (allow unused variables for module exports)
          shellcheck -S warning -e SC2034 modules/*.sh
          
          # Check legacy scripts (optional, allow failures)
          shellcheck -S warning legacy/cytadela++.sh || true
          shellcheck -S warning legacy/citadela_en.sh || true

      - name: Run Smoke Tests
        run: |
          # Run smoke tests (non-root, so some tests will be skipped)
          bash tests/smoke-test.sh || true

      - name: Run BATS Tests
        run: |
          # Install BATS if not available
          if ! command -v bats >/dev/null 2>&1; then
            sudo apt-get install -y bats
          fi
          # Run BATS unit tests
          bats tests/unit/ || true
