#!/bin/bash
# ╔═══════════════════════════════════════════════════════════════════════════╗
# ║  CYTADELA++ DEPENDENCIES CONFIGURATION                                    ║
# ║  Central registry of all external dependencies                            ║
# ╚═══════════════════════════════════════════════════════════════════════════╝

# =============================================================================
# REQUIRED DEPENDENCIES - Installation will fail without these
# =============================================================================

# Core system
declare -A CYTADELA_DEPS_REQUIRED=(
    [bash]="Shell interpreter|coreutils|/bin/bash"
    [systemctl]="Systemd service manager|systemd|/usr/bin/systemctl"
    [nft]="NFTables firewall|nftables|/usr/bin/nft"
    
    # DNS stack
    [dig]="DNS lookup utility|bind-tools|/usr/bin/dig"
    [coredns]="CoreDNS server|coredns|/usr/bin/coredns"
    [dnscrypt-proxy]="DNSCrypt proxy|dnscrypt-proxy|/usr/bin/dnscrypt-proxy"
    
    # Network tools
    [ip]="Network configuration|iproute2|/usr/bin/ip"
    [ss]="Socket statistics|iproute2|/usr/bin/ss"
    
    # Core utilities (usually built-in)
    [sha256sum]="SHA256 checksum|coreutils|/usr/bin/sha256sum"
    [mktemp]="Temporary file creation|coreutils|/usr/bin/mktemp"
    [chmod]="Change permissions|coreutils|/usr/bin/chmod"
    [chown]="Change ownership|coreutils|/usr/bin/chown"
    [mkdir]="Create directories|coreutils|/usr/bin/mkdir"
    [rm]="Remove files|coreutils|/usr/bin/rm"
    [cp]="Copy files|coreutils|/usr/bin/cp"
    [mv]="Move files|coreutils|/usr/bin/mv"
    [ln]="Create links|coreutils|/usr/bin/ln"
    [readlink]="Resolve symlinks|coreutils|/usr/bin/readlink"
    [id]="User identity|coreutils|/usr/bin/id"
    [whoami]="Current user|coreutils|/usr/bin/whoami"
    [hostname]="System hostname|coreutils|/usr/bin/hostname"
    [date]="Date/time|coreutils|/usr/bin/date"
    
    # Text processing (usually built-in)
    [grep]="Pattern search|grep|/usr/bin/grep"
    [awk]="Text processing|gawk|/usr/bin/awk"
    [sed]="Stream editor|sed|/usr/bin/sed"
    [sort]="Sort lines|coreutils|/usr/bin/sort"
    [uniq]="Unique lines|coreutils|/usr/bin/uniq"
    [wc]="Word count|coreutils|/usr/bin/wc"
    [cat]="Concatenate files|coreutils|/usr/bin/cat"
    [head]="First lines|coreutils|/usr/bin/head"
    [tail]="Last lines|coreutils|/usr/bin/tail"
    [tr]="Translate chars|coreutils|/usr/bin/tr"
    [cut]="Cut fields|coreutils|/usr/bin/cut"
    [printf]="Format output|coreutils|/usr/bin/printf"
)

# =============================================================================
# OPTIONAL DEPENDENCIES - Enhance functionality but not required
# =============================================================================

declare -A CYTADELA_DEPS_OPTIONAL=(
        # Interactive tools
    [gum]="Enhanced terminal UI|gum|/usr/bin/gum"
    
    # HTTP/JSON tools
    [curl]="HTTP client for metrics|curl|/usr/bin/curl"
    [jq]="JSON processor|jq|/usr/bin/jq"
    
    # Network management
    [nmcli]="NetworkManager CLI|networkmanager|/usr/bin/nmcli"
    [networkctl]="systemd-networkd CLI|systemd|/usr/bin/networkctl"
    
    # Desktop integration
    [notify-send]="Desktop notifications|libnotify|/usr/bin/notify-send"
    
    # Development tools
    [shellcheck]="Shell script linter|shellcheck|/usr/bin/shellcheck"
    [git]="Version control|git|/usr/bin/git"
    
    # DNS performance testing
    [dnsperf]="DNS performance benchmark|dnsperf|/usr/bin/dnsperf"
    [resperf]="Resolver performance test|dnsperf|/usr/bin/resperf"
    
    # Monitoring
    [prometheus]="Metrics server|prometheus|/usr/bin/prometheus"
    [grafana-server]="Dashboard server|grafana|/usr/bin/grafana-server"
    
    # Security tools
    [gpg]="GPG verification|gnupg|/usr/bin/gpg"
    [minisign]="Minisign verification|minisign|/usr/bin/minisign"
    [openssl]="SSL/TLS toolkit|openssl|/usr/bin/openssl"
    
    # Network diagnostics
    [lsof]="List open files|lsof|/usr/bin/lsof"
    [fuser]="Find process using file|psmisc|/usr/bin/fuser"
    [netstat]="Network statistics|net-tools|/usr/bin/netstat"
    
    # Container support
    [docker]="Docker containers|docker|/usr/bin/docker"
    [podman]="Podman containers|podman|/usr/bin/podman"
    
    # Additional system tools
    [htop]="Interactive process viewer|htop|/usr/bin/htop"
    [watch]="Execute periodically|procps-ng|/usr/bin/watch"
    [logger]="System log entry|util-linux|/usr/bin/logger"
    [journalctl]="Query journal|systemd|/usr/bin/journalctl"
    [find]="Find files|findutils|/usr/bin/find"
    [xargs]="Build command lines|findutils|/usr/bin/xargs"
    [tar]="Archive files|tar|/usr/bin/tar"
    [gzip]="Compress files|gzip|/usr/bin/gzip"
    [pgrep]="Process grep|procps-ng|/usr/bin/pgrep"
    [ps]="Process status|procps-ng|/usr/bin/ps"
)

# =============================================================================
# MODULE-SPECIFIC DEPENDENCIES
# =============================================================================

# Each module can declare its additional dependencies
declare -A CYTADELA_MODULE_DEPS=(
    # Benchmark module
    [benchmark:dnsperf]="dnsperf"
    [benchmark:resperf]="resperf"
    
    # Notify module  
    [notify:notify-send]="notify-send"
    
    # Prometheus module
    [prometheus:curl]="curl"
    [prometheus:jq]="jq"
    
    # Supply-chain module
    [supply-chain:curl]="curl"
    [supply-chain:sha256sum]="sha256sum"
    [supply-chain:openssl]="openssl"
    
    # Blocklist-manager module
    [blocklist:curl]="curl"
    
        # Install-wizard module (replaced by gum)
    # [install-wizard:whiptail]="whiptail"
    
    # Location module
    [location:nmcli]="nmcli"
    
    # Diagnostics module
    [diagnostics:curl]="curl"
    
    # IPv6 module
    [ipv6:nmcli]="nmcli"
    
    # Ghost-check module
    [ghost-check:lsof]="lsof"
    [ghost-check:fuser]="fuser"
    [ghost-check:ss]="ss"
    [ghost-check:netstat]="netstat"
    
    # Cache-stats module
    [cache-stats:curl]="curl"
    
    # Dashboard module
    [dashboard:watch]="procps-ng"
    
    # Additional module deps
    [health:pgrep]="pgrep"
    [health:ps]="ps"
    [emergency:kill]="kill"
    [emergency:logger]="logger"
    [config-backup:tar]="tar"
    [config-backup:gzip]="gzip"
    [adblock:find]="find"
    [lkg:tar]="tar"
    [lkg:gzip]="gzip"
    [lkg:openssl]="openssl"
    [integrity:openssl]="openssl"
    [integrity:gpg]="gpg"
    [install-dnscrypt:openssl]="openssl"
)

# =============================================================================
# HELPER FUNCTIONS
# =============================================================================

# Get package name for a command
deps_get_package() {
    local cmd="$1"
    local pkg=""
    
    # Check required deps
    if [[ -n "${CYTADELA_DEPS_REQUIRED[$cmd]}" ]]; then
        pkg="${CYTADELA_DEPS_REQUIRED[$cmd]}"
    elif [[ -n "${CYTADELA_DEPS_OPTIONAL[$cmd]}" ]]; then
        pkg="${CYTADELA_DEPS_OPTIONAL[$cmd]}"
    fi
    
    # Extract package name (2nd field separated by |)
    echo "$pkg" | cut -d'|' -f2
}

# Get description for a command
deps_get_description() {
    local cmd="$1"
    local pkg=""
    
    if [[ -n "${CYTADELA_DEPS_REQUIRED[$cmd]}" ]]; then
        pkg="${CYTADELA_DEPS_REQUIRED[$cmd]}"
    elif [[ -n "${CYTADELA_DEPS_OPTIONAL[$cmd]}" ]]; then
        pkg="${CYTADELA_DEPS_OPTIONAL[$cmd]}"
    fi
    
    # Extract description (1st field separated by |)
    echo "$pkg" | cut -d'|' -f1
}

# Check if a command is available
deps_check_command() {
    local cmd="$1"
    command -v "$cmd" &>/dev/null
}

# Get all optional deps for a module
deps_get_module_deps() {
    local module="$1"
    local deps=()
    
    for key in "${!CYTADELA_MODULE_DEPS[@]}"; do
        if [[ "$key" == "$module:"* ]]; then
            deps+=("${CYTADELA_MODULE_DEPS[$key]}")
        fi
    done
    
    echo "${deps[*]}"
}
